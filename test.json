openapi: 3.1.0
info:
  title: Strict OpenAPI Validator API
  version: 1.1.0
  summary: Validates OpenAPI specs for strict correctness and agent-readiness.
  description: |
    A strict validator that expects perfect validity.
    - Any schema/semantic error => validation fails.
    - Missing agent-readiness requirements => validation fails.

servers:
  - url: https://validator.example.com
    description: Production
  - url: http://localhost:8080
    description: Local

tags:
  - name: Validation
    description: Validate OpenAPI documents and return strict results.
  - name: Rules
    description: Discover validator rules and profiles.

security:
  - bearerAuth: []

paths:
  /validate:
    post:
      tags: [Validation]
      operationId: validateOpenApiSpec
      summary: Validate an OpenAPI document for strict correctness and agent-readiness.
      description: |
        Validates an OpenAPI 3.0/3.1 document. The validator is strict:
        if any required agent-readiness rule is unmet, the response is a 422 with errors.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ValidateRequest"
            examples:
              validStrictAgent:
                summary: Minimal valid request (strict-agent profile)
                value:
                  document:
                    format: json
                    content: '{"openapi":"3.1.0","info":{"title":"My API","version":"1.0.0"},"paths":{"/users":{"get":{"operationId":"listUsers","responses":{"200":{"description":"OK"}}}}}}'
                  profile: strict-agent
                  options:
                    failOnWarnings: true
                    includeNormalized: true
              validStrictSchema:
                summary: Strict schema-only validation
                value:
                  document:
                    format: yaml
                    content: |
                      openapi: 3.1.0
                      info:
                        title: My API
                        version: 1.0.0
                      paths:
                        /health:
                          get:
                            operationId: healthCheck
                            responses:
                              "200":
                                description: OK
                  profile: strict-schema
                  options:
                    failOnWarnings: true
                    includeNormalized: false
      responses:
        "200":
          description: Validation succeeded (no errors, no warnings).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidateSuccessResponse"
              examples:
                ok:
                  summary: Valid document
                  value:
                    valid: true
                    profile: strict-agent
                    stats:
                      errors: 0
                      warnings: 0
                      infos: 0
                    normalized:
                      format: json
                      content: '{"openapi":"3.1.0","info":{"title":"My API","version":"1.0.0"},"paths":{"/users":{"get":{"operationId":"listUsers","responses":{"200":{"description":"OK"}}}}}}'
                    checks:
                      schemaValidity: pass
                      agentReadiness: pass
        "422":
          description: Validation failed (at least one strict rule violated).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidateFailureResponse"
              examples:
                missingOperationId:
                  summary: Agent readiness failure (missing operationId)
                  value:
                    valid: false
                    profile: strict-agent
                    stats:
                      errors: 1
                      warnings: 0
                      infos: 0
                    errors:
                      - code: AGENT_OPERATION_ID_REQUIRED
                        message: "Every operation must define a stable operationId."
                        severity: error
                        location:
                          jsonPointer: "/paths/~1users/get/operationId"
                        remediation:
                          suggestion: "Add operationId: listUsers"
                schemaInvalid:
                  summary: OpenAPI schema failure
                  value:
                    valid: false
                    profile: strict-schema
                    stats:
                      errors: 1
                      warnings: 0
                      infos: 0
                    errors:
                      - code: OAS_SCHEMA_INVALID
                        message: "paths must define at least one operation."
                        severity: error
                        location:
                          jsonPointer: "/paths"
                        remediation:
                          suggestion: "Define at least one path item with an HTTP operation (get/post/...)."
        "400":
          description: Malformed request (missing document, unsupported format, etc.).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                badRequest:
                  summary: Missing document
                  value:
                    error:
                      code: BAD_REQUEST
                      message: "Missing required field: document"
                    requestId: "req_01HXYZ..."
        "401":
          description: Missing/invalid authentication credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                unauthorized:
                  summary: No bearer token
                  value:
                    error:
                      code: UNAUTHORIZED
                      message: "Missing or invalid bearer token."
                    requestId: "req_01HXYZ..."
        "415":
          description: Unsupported media type.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                unsupported:
                  summary: Wrong content-type
                  value:
                    error:
                      code: UNSUPPORTED_MEDIA_TYPE
                      message: "Content-Type must be application/json."
                    requestId: "req_01HXYZ..."
        "500":
          description: Validator internal error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                internal:
                  summary: Unexpected failure
                  value:
                    error:
                      code: INTERNAL
                      message: "Unexpected error while validating."
                    requestId: "req_01HXYZ..."

  /rules:
    get:
      tags: [Rules]
      operationId: listValidationRules
      summary: List validator rules (schema + agent-readiness).
      description: Returns the full rule catalog. Use `profile` to filter.
      security:
        - bearerAuth: []
      parameters:
        - name: profile
          in: query
          required: false
          description: Filter rules by a validation profile.
          schema:
            $ref: "#/components/schemas/Profile"
          examples:
            strictAgent:
              value: strict-agent
            strictSchema:
              value: strict-schema
      responses:
        "200":
          description: Rule catalog.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RulesResponse"
              examples:
                strictAgentRules:
                  summary: Example rules response
                  value:
                    profile: strict-agent
                    rules:
                      - code: OAS_SCHEMA_VALID
                        category: openapi
                        severity: error
                        description: "OpenAPI document must be valid against OpenAPI 3.x."
                        enabledByDefault: true
                      - code: AGENT_OPERATION_ID_REQUIRED
                        category: agent
                        severity: error
                        description: "Every operation must define operationId."
                        enabledByDefault: true
                      - code: AGENT_EXAMPLES_REQUIRED
                        category: agent
                        severity: error
                        description: "Every operation must include request/response examples."
                        enabledByDefault: true
                      - code: AGENT_TAGS_REQUIRED
                        category: agent
                        severity: error
                        description: "Every operation must declare at least one tag."
                        enabledByDefault: true
        "400":
          description: Malformed request (e.g., invalid profile parameter).
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                badProfile:
                  summary: Invalid profile
                  value:
                    error:
                      code: BAD_REQUEST
                      message: "Invalid profile. Allowed: strict-agent, strict-schema."
                    requestId: "req_01HXYZ..."
        "401":
          description: Missing/invalid authentication credentials.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                unauthorized:
                  summary: No bearer token
                  value:
                    error:
                      code: UNAUTHORIZED
                      message: "Missing or invalid bearer token."
                    requestId: "req_01HXYZ..."
        "500":
          description: Validator internal error.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                internal:
                  summary: Unexpected failure
                  value:
                    error:
                      code: INTERNAL
                      message: "Unexpected error while listing rules."
                    requestId: "req_01HXYZ..."

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Provide a bearer token in the Authorization header:
        Authorization: Bearer <token>

  schemas:
    ValidateRequest:
      type: object
      additionalProperties: false
      required: [document]
      properties:
        document:
          $ref: "#/components/schemas/OpenApiDocumentInput"
        profile:
          $ref: "#/components/schemas/Profile"
        options:
          $ref: "#/components/schemas/ValidationOptions"

    OpenApiDocumentInput:
      type: object
      additionalProperties: false
      required: [format, content]
      properties:
        format:
          type: string
          enum: [json, yaml]
          description: The serialization format of `content`.
        content:
          type: string
          description: The OpenAPI document as a raw string (JSON or YAML).
        sourceName:
          type: string
          description: Optional identifier for reporting (e.g., filename, URL).

    Profile:
      type: string
      enum: [strict-agent, strict-schema]
      description: |
        - strict-agent: strict schema validity + agent-readiness rules (no warnings allowed).
        - strict-schema: strict OpenAPI validity only (no warnings allowed).

    ValidationOptions:
      type: object
      additionalProperties: false
      properties:
        failOnWarnings:
          type: boolean
          default: true
          description: If true, warnings fail validation (strict mode).
        maxErrors:
          type: integer
          minimum: 1
          maximum: 1000
          default: 200
          description: Stop after returning this many errors.
        includeNormalized:
          type: boolean
          default: true
          description: If true, return a normalized/cleaned OpenAPI document when valid.
        agentReadiness:
          $ref: "#/components/schemas/AgentReadinessOptions"

    AgentReadinessOptions:
      type: object
      additionalProperties: false
      description: Strict requirements aimed at tool/agent consumption.
      properties:
        requireOperationId:
          type: boolean
          default: true
        requireDescriptions:
          type: boolean
          default: true
        requireRequestBodySchema:
          type: boolean
          default: true
          description: For operations with a requestBody, require a JSON Schema for each content type.
        requireResponseSchemas:
          type: boolean
          default: true
          description: Require JSON Schemas for all responses that have content.
        requireExamples:
          type: boolean
          default: true
          description: Require request and response examples for all operations.
        requireTags:
          type: boolean
          default: true
          description: Require tags for all operations.
        requireAuthDeclaration:
          type: boolean
          default: true
          description: Require securitySchemes and operation/global security.
        forbidAnyOfOneOfWithoutDiscriminator:
          type: boolean
          default: false
          description: If true, enforce discriminator for polymorphic unions used in request/response models.

    ValidateSuccessResponse:
      type: object
      additionalProperties: false
      required: [valid, profile, stats, checks]
      properties:
        valid:
          type: boolean
          const: true
        profile:
          $ref: "#/components/schemas/Profile"
        stats:
          $ref: "#/components/schemas/ValidationStats"
        checks:
          $ref: "#/components/schemas/ChecksSummary"
        normalized:
          $ref: "#/components/schemas/NormalizedDocument"

    ValidateFailureResponse:
      type: object
      additionalProperties: false
      required: [valid, profile, stats, errors]
      properties:
        valid:
          type: boolean
          const: false
        profile:
          $ref: "#/components/schemas/Profile"
        stats:
          $ref: "#/components/schemas/ValidationStats"
        errors:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/ValidationIssue"

    ValidationStats:
      type: object
      additionalProperties: false
      required: [errors, warnings, infos]
      properties:
        errors:
          type: integer
          minimum: 0
        warnings:
          type: integer
          minimum: 0
        infos:
          type: integer
          minimum: 0

    ChecksSummary:
      type: object
      additionalProperties: false
      required: [schemaValidity, agentReadiness]
      properties:
        schemaValidity:
          type: string
          enum: [pass, fail]
        agentReadiness:
          type: string
          enum: [pass, fail]

    NormalizedDocument:
      type: object
      additionalProperties: false
      required: [format, content]
      properties:
        format:
          type: string
          enum: [json, yaml]
        content:
          type: string
          description: Normalized OpenAPI document (stable ordering, deref/cleanup as implemented).

    ValidationIssue:
      type: object
      additionalProperties: false
      required: [code, message, severity, location]
      properties:
        code:
          type: string
          description: Stable machine-readable code (e.g., OAS_SCHEMA_INVALID, AGENT_OPERATION_ID_REQUIRED).
        message:
          type: string
          description: Human-readable error.
        severity:
          type: string
          enum: [error, warning, info]
        location:
          $ref: "#/components/schemas/IssueLocation"
        remediation:
          $ref: "#/components/schemas/Remediation"
        docsUrl:
          type: string
          format: uri
          description: Optional link to rule documentation.

    IssueLocation:
      type: object
      additionalProperties: false
      required: [jsonPointer]
      properties:
        jsonPointer:
          type: string
          description: JSON Pointer to the violating node (RFC 6901).
        line:
          type: integer
          minimum: 1
          description: Optional 1-based line number in the source document.
        column:
          type: integer
          minimum: 1
          description: Optional 1-based column number in the source document.

    Remediation:
      type: object
      additionalProperties: false
      properties:
        suggestion:
          type: string
          description: Concrete fix guidance.
        example:
          type: string
          description: Short example snippet.

    RulesResponse:
      type: object
      additionalProperties: false
      required: [profile, rules]
      properties:
        profile:
          $ref: "#/components/schemas/Profile"
        rules:
          type: array
          items:
            $ref: "#/components/schemas/RuleDescriptor"

    RuleDescriptor:
      type: object
      additionalProperties: false
      required: [code, category, severity, description]
      properties:
        code:
          type: string
        category:
          type: string
          enum: [openapi, jsonschema, agent]
        severity:
          type: string
          enum: [error, warning, info]
        description:
          type: string
        enabledByDefault:
          type: boolean
          default: true

    ErrorResponse:
      type: object
      additionalProperties: false
      required: [error]
      properties:
        error:
          type: object
          additionalProperties: false
          required: [code, message]
          properties:
            code:
              type: string
            message:
              type: string
            requestId:
              type: string
              description: Optional trace identifier for support.
